"use strict";var R=Object.create;var I=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var T=(t,s,e,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of w(s))!S.call(t,o)&&o!==e&&I(t,o,{get:()=>s[o],enumerable:!(n=b(s,o))||n.enumerable});return t};var f=(t,s,e)=>(e=t!=null?R(A(t)):{},T(s||!t||!t.__esModule?I(e,"default",{value:t,enumerable:!0}):e,t));var v=f(require("fastify"));var D=require("dotenv/config"),i=require("zod"),U=i.z.object({NODE_ENV:i.z.enum(["development","production","test"]).default("development"),DATABASE_URL:i.z.string(),PORT:i.z.number().default(3333)}),p=U.safeParse(process.env);if(p.success===!1)throw console.error("\u274C Invalid environment variables",p.error.format()),new Error("Invalid environment variables.");var m=p.data;var r=require("zod"),l=f(require("crypto"));var g=require("knex");var _={client:"sqlite3",connection:{filename:m.DATABASE_URL},useNullAsDefault:!0,migrations:{extension:"ts",directory:"./db/migrations"}},a=(0,g.knex)(_);async function d(t,s){if(!t.cookies.sessionId)return s.status(401).send({error:"Unauthorized"})}async function x(t){t.addHook("preHandler",async s=>{console.log(`[${s.method}] ${s.url}`)}),t.get("/",{preHandler:[d]},async(s,e)=>{let n=s.cookies.sessionId;return n?{transactions:await a("transactions").select("*").where({session_id:n})}:e.status(401).send({error:"Unauthorized"})}),t.get("/:id",{preHandler:[d]},async s=>{let e=r.z.object({id:r.z.string().uuid()}),{id:n}=e.parse(s.params),{sessionId:o}=s.cookies;return{transaction:await a("transactions").where({id:n,session_id:o}).first()}}),t.get("/summary",{preHandler:[d]},async s=>{let{sessionId:e}=s.cookies;return{summary:await a("transactions").sum("amount",{as:"amount"}).where({session_id:e}).first()}}),t.post("/",async(s,e)=>{let n=r.z.object({title:r.z.string(),amount:r.z.number(),type:r.z.enum(["credit","debit"])}),{title:o,amount:u,type:k}=n.parse(s.body),c=s.cookies.sessionId;return c||(c=l.default.randomUUID(),e.cookie("sessionId",c,{path:"/",maxAge:3600*24*7})),await a("transactions").insert({id:l.default.randomUUID(),title:o,amount:k==="credit"?u:u*-1,session_id:c}),e.status(201).send()})}var h=f(require("@fastify/cookie")),y=(0,v.default)();y.register(h.default);y.register(x,{prefix:"transactions"});y.listen({port:m.PORT}).then(()=>{console.log("HTTP Server Running!")});
