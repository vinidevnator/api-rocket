"use strict";var g=Object.create;var m=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty;var w=(t,s)=>{for(var e in s)m(t,e,{get:s[e],enumerable:!0})},p=(t,s,e,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of v(s))!b.call(t,o)&&o!==e&&m(t,o,{get:()=>s[o],enumerable:!(n=h(s,o))||n.enumerable});return t};var A=(t,s,e)=>(e=t!=null?g(k(t)):{},p(s||!t||!t.__esModule?m(e,"default",{value:t,enumerable:!0}):e,t)),R=t=>p(m({},"__esModule",{value:!0}),t);var S={};w(S,{transactionsRoutes:()=>E});module.exports=R(S);var r=require("zod"),l=A(require("crypto"));var I=require("knex");var F=require("dotenv/config"),i=require("zod"),U=i.z.object({NODE_ENV:i.z.enum(["development","production","test"]).default("development"),DATABASE_URL:i.z.string(),PORT:i.z.number().default(3333)}),f=U.safeParse(process.env);if(f.success===!1)throw console.error("\u274C Invalid environment variables",f.error.format()),new Error("Invalid environment variables.");var y=f.data;var _={client:"sqlite3",connection:{filename:y.DATABASE_URL},useNullAsDefault:!0,migrations:{extension:"ts",directory:"./db/migrations"}},a=(0,I.knex)(_);async function d(t,s){if(!t.cookies.sessionId)return s.status(401).send({error:"Unauthorized"})}async function E(t){t.addHook("preHandler",async s=>{console.log(`[${s.method}] ${s.url}`)}),t.get("/",{preHandler:[d]},async(s,e)=>{let n=s.cookies.sessionId;return n?{transactions:await a("transactions").select("*").where({session_id:n})}:e.status(401).send({error:"Unauthorized"})}),t.get("/:id",{preHandler:[d]},async s=>{let e=r.z.object({id:r.z.string().uuid()}),{id:n}=e.parse(s.params),{sessionId:o}=s.cookies;return{transaction:await a("transactions").where({id:n,session_id:o}).first()}}),t.get("/summary",{preHandler:[d]},async s=>{let{sessionId:e}=s.cookies;return{summary:await a("transactions").sum("amount",{as:"amount"}).where({session_id:e}).first()}}),t.post("/",async(s,e)=>{let n=r.z.object({title:r.z.string(),amount:r.z.number(),type:r.z.enum(["credit","debit"])}),{title:o,amount:u,type:x}=n.parse(s.body),c=s.cookies.sessionId;return c||(c=l.default.randomUUID(),e.cookie("sessionId",c,{path:"/",maxAge:3600*24*7})),await a("transactions").insert({id:l.default.randomUUID(),title:o,amount:x==="credit"?u:u*-1,session_id:c}),e.status(201).send()})}0&&(module.exports={transactionsRoutes});
